name: CI/CD - WebStackBase

on:
  push:
    branches:
      - principal
  pull_request:
    branches:
      - principal

jobs:
  build-and-test:
    name: ðŸ”¨ Build & âœ… Test
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ§° Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: ðŸ“¦ Restore dependencies
        run: dotnet restore ./api/WebStackBase.Api.sln

      - name: ðŸ› ï¸ Build
        run: dotnet build ./api/WebStackBase.Api.sln --configuration Release --no-restore

      - name: ðŸ§ª Run tests
        run: dotnet test ./api/WebStackBase.Tests/WebStackBase.Tests.csproj --verbosity normal

      - name: ðŸ“¤ Publish WebAPI
        run: dotnet publish ./api/WebStackBase.WebAPI/WebStackBase.WebAPI.csproj --configuration Release --output ./api/WebStackBase.WebAPI/publish

      # - name: ðŸš€ Deploy to VPS via SCP and SSH
      #   env:
      #     SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      #     VPS_USER: ${{ secrets.VPS_USER }}
      #     VPS_HOST: ${{ secrets.VPS_HOST }}
      #     VPS_PORT: ${{ secrets.VPS_PORT }}
      #   run: |
      #     echo "$SSH_PRIVATE_KEY" > private_key
      #     chmod 600 private_key

      #     echo "ðŸ“¦ Copying files to VPS..."
      #     scp -i private_key -P $VPS_PORT -r ./api/WebStackBase.WebAPI/publish $VPS_USER@$VPS_HOST:/var/www/webstackbase-temp

      #     echo "ðŸš€ Deploying to production..."
      #     ssh -i private_key -p $VPS_PORT $VPS_USER@$VPS_HOST << 'EOF'
      #       sudo systemctl stop webstackbase-api
      #       rm -rf /var/www/webstackbase/*
      #       mv /var/www/webstackbase-temp/* /var/www/webstackbase/
      #       rm -rf /var/www/webstackbase-temp
      #       sudo systemctl start webstackbase-api
      #     EOF
      #     rm private_key

  deploy-docker-compose:
    name: ðŸšš Copy Docker Compose to VPS
    runs-on: ubuntu-latest
    needs: build-and-test 
    
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v3
    
      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
      - name: Copy docker-compose.sqlserver.yml to VPS
        run: |
          scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null infra/docker-compose.sqlserver.yml ${VPS_USER}@${VPS_HOST}:/opt/sqlserver/docker-compose.sqlserver.yml
    
      - name: Verify the file on the VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} 'ls /opt/sqlserver/docker-compose.sqlserver.yml'